<!DOCTYPE html>
<html lang="es" class="dark h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}YASTA Dashboard{% endblock %}</title>
    
    <!-- === FUENTES === -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">

    <!-- === ESTILOS === -->
    <link rel="stylesheet" href="{{ url_for('static', path='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='css/forms.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='css/modal_universal.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='css/payment_flow.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='css/declaration_rows.css') }}">
    
    {% block page_css %}{% endblock %}

    <!-- === SCRIPTS DE LIBRERÍAS === -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/hyperscript.org@0.9.12"></script>
    
    <!-- === SCRIPTS DE LA APLICACIÓN === -->
    <script src="{{ url_for('static', path='js/modal_universal.js') }}" defer></script>
    <script src="{{ url_for('static', path='js/main.js') }}" defer></script>

    <!-- =================================================================== -->
    <!-- === INICIO: ESTILOS DEFINITIVOS PARA EL LAYOUT === -->
    <!-- =================================================================== -->
    <style>
        /* 1. Reglas para la cabecera fija */
        #app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        /* 2. Compensamos la altura de la cabecera en el body */
        body {
            padding-top: 4rem; /* 64px, asumiendo que esa es la altura del header */
        }

        /* 3. Estilos del menú de usuario (sin cambios, solo centralizados aquí) */
        .user-menu-container { position: relative; }
        .dropdown-menu { position: absolute; right: 0; top: 100%; margin-top: 0.5rem; background-color: #2d3748; border: 1px solid #4a5568; border-radius: 0.375rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); width: 12rem; z-index: 90; }
        .dropdown-link { display: block; padding: 0.5rem 1rem; font-size: 0.875rem; color: #e2e8f0; transition: background-color 0.2s, color 0.2s; cursor: pointer; }
        .dropdown-link:hover { background-color: #4f46e5; color: #fff; }
        .dropdown-arrow { transition: transform 0.2s; }
        .dropdown-arrow.rotate-180 { transform: rotate(180deg); }
    </style>
    <!-- =================================================================== -->
    <!-- === FIN: ESTILOS DEFINITIVOS === -->
    <!-- =================================================================== -->
</head>

<!-- ELIMINAMOS las clases flex flex-col min-h-screen del body -->
<body class="bg-gray-900 text-gray-100" hx-ext="head-support">

    <!-- La cabecera se incluye directamente. El padding del body la compensará. -->
    {% include 'partials/_app_header.html' %}

    <!-- Sub-navegación (si existe) -->
    {% if self.sub_nav_content() and self.sub_nav_content().strip() %}
        <nav id="sub-nav" class="bg-gray-800/80 backdrop-blur-sm border-b border-gray-700/50">
            <div class="container mx-auto px-4 h-12 flex items-center">
                {% block sub_nav_content %}{% endblock %}
            </div>
        </nav>
    {% endif %}

    <!-- El contenido principal de cada página hija se insertará aquí -->
    <!-- ELIMINAMOS las clases flex-grow y pt-16 de main -->
    <main>
        {% block main_content %}{% endblock %}
    </main>
    
    <!-- Scripts específicos de la página -->
    {% block page_scripts %}{% endblock %}

    <!-- Contenedor para los Modales -->
    <div id="modal-container-placeholder"></div>

    <!-- Scripts de final de body -->
    {% block body_end_scripts %}{% endblock %}

    <!-- Scripts globales de inicialización (CON TU CÓDIGO ORIGINAL RESTAURADO) -->
    <script>
        // --- FUNCIONES UNIVERSALES DISPONIBLES EN TODA LA APP ---
        function initializeOnboardingForm(containerElement) {
            if (!containerElement) return;
            const form = containerElement.querySelector('form');
            if (!form) return;
            console.log("[Global Logic] Inicializando formulario en:", containerElement);
            
            const rucInput = form.querySelector('#client_ruc_modal');
            const rucDetailsContainer = form.querySelector('#ruc-details');
            const businessNameInput = form.querySelector('#business_name');
            const businessAddressInput = form.querySelector('#business_address');
            const rucSpinner = form.querySelector('#ruc-spinner');
            const passInput = form.querySelector('#sol_password_modal');
            const passConfirmInput = form.querySelector('#sol_password_confirm_modal');

            const handleRucValidation = async () => {
                if (!rucInput) return;
                const ruc = rucInput.value.trim();
                if (rucDetailsContainer) rucDetailsContainer.classList.add('hidden');
                if (ruc.length !== 11 || !/^(10|20)\d{9}$/.test(ruc)) return;
                if (rucSpinner) rucSpinner.classList.remove('hidden');
                rucInput.readOnly = true;
                try {
                    const response = await fetch(`/api/v1/utils/sunat-info/${ruc}`);
                    if (!response.ok) throw new Error('No se pudo validar el RUC.');
                    const data = await response.json();
                    if (businessNameInput) businessNameInput.value = data.razonSocial;
                    if (businessAddressInput) businessAddressInput.value = data.direccion;
                    if (rucDetailsContainer) rucDetailsContainer.classList.remove('hidden');
                } catch (error) { alert(`Error: ${error.message}`);
                } finally {
                    if (rucSpinner) rucSpinner.classList.add('hidden');
                    rucInput.readOnly = false;
                }
            };
            const handleFormSubmit = (event) => {
                if (!passInput || !passConfirmInput) return;
                if (passInput.value !== passConfirmInput.value) {
                    event.preventDefault();
                    alert('Las Claves SOL no coinciden.');
                }
            };
            if (rucInput) rucInput.addEventListener('blur', handleRucValidation);
            form.addEventListener('submit', handleFormSubmit);
        }

        function resetOnboardingForm() {
            const modal = document.querySelector('#modalOnboardingRUC, #modalRegistrarRuc');
            if (!modal) return;
            const form = modal.querySelector('form');
            if (form) form.reset();
            const rucDetails = modal.querySelector('#ruc-details');
            if (rucDetails) rucDetails.classList.add('hidden');
        }

        // --- INICIALIZACIÓN DE HYPERSCRIPT ---
        function initializeHyperscript() {
            _hyperscript.processNode(document.body);
            console.log("Hyperscript inicializado en el body.");
        }
        document.addEventListener('DOMContentLoaded', initializeHyperscript);
        htmx.on("htmx:afterSwap", (evt) => {
            if (evt.detail.elt) {
                console.log("HTMX afterSwap. Procesando nuevo nodo con Hyperscript:", evt.detail.elt);
                _hyperscript.processNode(evt.detail.elt);
            }
        });
    </script>
</body>
</html>