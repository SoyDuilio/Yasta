<div class="task-card-container">
    {% for task in assigned_tasks %}
    {% set contract = task.contract %}
    {% set profile = task.profile %}
    {% set declaration_req = task.declaration_request %}
    {% set due_date = task.due_date %}

    <div class="task-card" id="task-card-{{ contract.id }}">
        
        <!-- Fila 1: RUC, Razón Social y Estado Actual -->
        <div class="task-card-row">
            <div class="client-info">
                <span class="ruc-chip">{{ profile.ruc }}</span>
                <h4 class="business-name">{{ profile.business_name }}</h4>
            </div>
            <div id="status-badge-wrapper-{{ contract.id }}">
                {% include 'dashboards/staff/partials/_task_status_badge.html' %}
            </div>
        </div>

        <!-- Fila 2: Detalles de la Tarea -->
        <div class="task-card-details-grid">
            <div class="detail-header">Tipo DJ</div>
            <div class="detail-header">Asignada</div>
            <div class="detail-header">Vencimiento</div>
            <div class="detail-header">Periodo</div>

            <div class="detail-value font-semibold text-white">{{ declaration_req.declaration_type.name|replace('_', ' ')|title }}</div>
            <div class="detail-value">{{ contract.assigned_at.strftime('%d %b %Y') if contract.assigned_at else 'N/A' }}</div>
            <div class="detail-value {% if due_date and (due_date - today).days < 7 %}text-red-400{% else %}text-orange-300{% endif %}">
                {{ due_date.strftime('%d %b %Y') if due_date else 'N/A' }}
            </div>
            <div class="detail-value">{{ contract.tax_period }}</div>
        </div>

        <!-- Fila 3: Acciones del Contador -->
        <div class="task-card-row task-card-actions">
            <div id="sol-button-area-{{ contract.id }}" class="sol-button-container">
                <button id="btn-copy-sol-{{ contract.id }}" class="btn-action"
                        hx-post="{{ url_for('staff_copy_sol_password', contract_id=contract.id) }}"
                        hx-target="closest .sol-button-container" hx-swap="outerHTML">
                    Copiar Clave SOL
                </button>
            </div>
            
            <form hx-get="{{ url_for('staff_confirm_update_status') }}"
                  hx-target="#modal-container" hx-swap="innerHTML"
                  style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="hidden" name="contract_id" value="{{ contract.id }}">
                <select name="new_status" class="form-select" required>
                    <option value="" disabled selected>Cambiar estado...</option>
                    {% for status in available_statuses %}
                    <option value="{{ status.value }}">{{ status.name.replace('_', ' ')|title }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn-action primary">Actualizar</button>
            </form>
        </div>
    </div>
        {% include 'dashboards/staff/partials/_staff_task_card.html' %}
    {% else %}
    <div class="text-center text-gray-400 p-8">¡Felicidades! No tienes tareas activas.</div>
    {% endfor %}
</div>