{% extends 'layouts/_app_base.html' %}

{% block title %}Mi Dashboard - YASTA{% endblock %}

{% block page_css %}
    <!-- Los estilos del dashboard se quedan igual -->
    <style>
        .dashboard-grid { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 1.5rem; }
        @media (min-width: 768px) { .dashboard-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
        @media (min-width: 1280px) { .dashboard-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
        .dashboard-widget { background-color: #1f2937; border-radius: 0.75rem; padding: 1.5rem; border: 1px solid #374151; }
        /* ...etc... */
    </style>
{% endblock %}


{% block sub_nav_content %}
    {% if current_user.sol_validation_status.value == 'valid' %}
        <div class="flex items-center space-x-4">
            <a href="#" class="px-1 py-2 text-sm font-semibold text-white border-b-2 border-indigo-500">Resumen</a>
        </div>
    {% endif %}
{% endblock %}


{% block main_content %}
<div class="container mx-auto px-4">
    {% if current_user.sol_validation_status.value != 'valid' %}
        <!-- Vista de Onboarding -->
    {% else %}
        <!-- DASHBOARD COMPLETO -->
        <div>
            <header class="mb-8 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-white">Resumen del Periodo</h1>
                    <p class="text-gray-400 mt-1">Hola {{ current_user.contact_name }}, aquí tienes un vistazo rápido.</p>
                </div>
                <div>
                    <!-- Este botón activa el flujo de pago y carga el formulario inicial -->
                    <button 
                        hx-get="/app/payments/new?cache_bust={{ now() | int }}" 
                        hx-target=".payment-flow__content"
                        hx-swap="innerHTML"
                        _="on htmx:afterRequest add .is-active to .payment-flow"
                        class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        Registrar un Pago
                    </button>
                </div>
            </header>
            <div class="dashboard-grid">
                <div class="dashboard-widget"><h3 class="widget-title">Impuesto por Pagar (Junio)</h3><p class="kpi-value">S/ 1,250.00</p><p class="kpi-label">IGV + Renta</p></div>
                <div class="dashboard-widget"><h3 class="widget-title">Próximo Vencimiento</h3><p class="kpi-value text-yellow-400">En 5 días</p><p class="kpi-label">Declaración PLAME</p></div>
                <div class="dashboard-widget"><h3 class="widget-title">Alertas Activas</h3><p class="kpi-value text-red-500">1</p><p class="kpi-label">Orden de Pago pendiente</p></div>
                <div class="dashboard-widget xl:col-span-2"><h3 class="widget-title">Historial de Impuestos Pagados</h3><div class="chart-container-widget"><canvas id="clientLineChart"></canvas></div></div>
                <div class="dashboard-widget"><h3 class="widget-title">Distribución de Gastos</h3><div class="chart-container-widget"><canvas id="clientPieChart"></canvas></div></div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}


{% block body_end_scripts %}
    <!-- EL NUEVO ESQUELETO DEL FLUJO DE PAGO -->
    <div class="payment-flow">
        <div class="payment-flow__overlay" _="on click remove .is-active from me.parentElement"></div>
        
        <div class="payment-flow__panel">
            <button class="payment-flow__close-btn" _="on click remove .is-active from closest .payment-flow">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            
            <!-- Contenedor donde HTMX inyectará el contenido -->
            <div class="payment-flow__content">
                <div class="htmx-indicator text-white text-center"><p>Cargando...</p></div>
            </div>
        </div>
    </div>
{% endblock %}